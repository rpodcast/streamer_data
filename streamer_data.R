# load packages ----
library(dplyr)
library(tidyr)
library(purrr)
library(aws.s3)

# import config settings ----
config <- config::get()

# ensure the here package is tracked by renv
my_dir <- here::here()

# set up authentication via environment variables
twitchr::twitch_auth()

# load scripts ----
source("utils.R")

# import yaml files ----
yml_files <- fs::dir_ls("yaml_files")
yml_data <- purrr::map(yml_files, ~yaml::read_yaml(file = .x)) %>%
  tibble::tibble() %>%
  tidyr::unnest_wider(1)

streamer_data <- yml_data %>%
    dplyr::filter(platform == "twitch") %>%
    dplyr::mutate(user_data = purrr::map(user_id, ~get_twitch_id(user_name = .x))) %>%
    tidyr::unnest(cols = user_data) %>%
    dplyr::mutate(schedule_data = purrr::map(id, ~get_twitch_schedule(.x)),
                  videos_list = purrr::map(id, ~get_twitch_videos(.x))) %>%
    dplyr::mutate(video_recent = purrr::map_lgl(videos_list, function(x) {
      if (is.na(x)) {
        return(FALSE)
      } else {
        return(x$video_recent)
      }
    })) %>%
    filter(video_recent) %>%
    dplyr::mutate(video_data = purrr::map(videos_list, function(x) x[["video_id"]])) %>%
    select(., -video_recent, -videos_list)

# remove any rows with null schedule_data
streamer_data <- streamer_data %>%
  mutate(schedule_valid = purrr::map_lgl(schedule_data, ~!is.null(.x))) %>%
  filter(schedule_valid) %>%
  select(., -schedule_valid)

if (config::is_active("production")) {
  s3saveRDS(
    x = streamer_data,
    object = "streamer_data_current.rds",
    acl = "public-read",
    bucket = Sys.getenv("DO_SPACE"),
    key = Sys.getenv("DO_ACCESS_KEY_ID"),
    secret = Sys.getenv("DO_SECRET_ACCESS_KEY"),
    region = Sys.getenv("DO_DATACENTER"),
    base_url = "linodeobjects.com"
  )
} else {
  saveRDS(streamer_data, file = "data/streamer_data_current.rds")
}
